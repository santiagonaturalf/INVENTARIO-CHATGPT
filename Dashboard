<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; margin: 10px; background-color: #f9f9f9; }
      h2 { color: #4285F4; margin-top: 0; }

      /* Tab container */
      .tab { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 10px; }
      .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 12px 16px; transition: 0.3s; font-size: 16px; border-radius: 6px 6px 0 0; }
      .tab button:hover { background-color: #ddd; }
      .tab button.active { background-color: #4285F4; color: white; font-weight: bold; }

      /* Tab content */
      .tabcontent { display: none; padding: 6px 0; border-top: none; }
      .tabcontent h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 15px; }

      #table-wrapper, .category-table-wrapper { max-height: 420px; overflow-y: auto; border: 1px solid #ccc; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
      th { background-color: #f2f2f2; position: sticky; top: 0; }

      #search-input {
        width: 100%;
        font-size: 14px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }

      #footer-buttons { text-align: right; margin-top: 15px; }
      button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;}
      button:hover { opacity: 0.8; }
      #btn-query { background-color: #008CBA; }

      /* Accordion styles */
      .accordion {
        background-color: #eee;
        color: #444;
        cursor: pointer;
        padding: 18px;
        width: 100%;
        border: none;
        text-align: left;
        outline: none;
        font-size: 15px;
        transition: 0.4s;
        border-bottom: 1px solid #ddd;
      }
      .active, .accordion:hover {
        background-color: #ccc;
      }
      .panel {
        padding: 0 18px;
        background-color: white;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.2s ease-out;
      }
      .panel table {
          width: 100%;
          margin-top: 10px;
          margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <h2>Dashboard de Inventario Diario</h2>

    <div class="tab">
      <button class="tablinks" onclick="openView(event, 'DetailedView')" id="defaultOpen">Vista Detallada</button>
      <button class="tablinks" onclick="openView(event, 'CategoryView')">Vista por Categoría</button>
      <button class="tablinks" onclick="openView(event, 'SalesView')">Visor de Ventas</button>
    </div>

    <div id="DetailedView" class="tabcontent">
      <input type="text" id="search-input" onkeyup="filterTable()" placeholder="Buscar por Producto Base...">
      <div id="table-wrapper">
        <table id="detailed-table">
          <thead>
            <tr>
              <th>Producto Base</th>
              <th>Ultimo Stock</th>
              <th>Stock Esperado</th>
              <th>Unidad</th>
              <th>Stock Real Hoy</th>
              <th>Adq. Hoy</th>
              <th>Formato Adq.</th>
              <th>Vendido Hoy</th>
              <th>Detalle Venta</th>
            </tr>
          </thead>
          <tbody>
            <? for (let i = 0; i < inventoryData.length; i++) { ?>
              <tr>
                <td><?= inventoryData[i][0] ?></td>
                <td><?= inventoryData[i][1] ?></td>
                <td><?= inventoryData[i][2] ?></td>
                <td><?= inventoryData[i][3] ?></td>
                <td><?= inventoryData[i][4] ?></td>
                <td><?= inventoryData[i][5] ?></td>
                <td><?= inventoryData[i][6] ?></td>
                <td><?= inventoryData[i][7] ?></td>
                <td><?= inventoryData[i][8] ?></td>
              </tr>
            <? } ?>
          </tbody>
        </table>
      </div>
    </div>

    <div id="CategoryView" class="tabcontent">
      <div class="category-table-wrapper">
        <? const categories = Object.keys(inventoryByCategory); ?>
        <? for (let i = 0; i < categories.length; i++) { ?>
          <h3><?= categories[i] ?></h3>
          <table>
            <thead>
              <tr>
                <th>Producto Base</th>
                <th>Stock Esperado</th>
                <th>Unidad</th>
              </tr>
            </thead>
            <tbody>
              <? const products = inventoryByCategory[categories[i]]; ?>
              <? for (let j = 0; j < products.length; j++) { ?>
                <tr>
                  <td><?= products[j][0] ?></td>
                  <td><?= products[j][2] ?></td>
                  <td><?= products[j][3] ?></td>
                </tr>
              <? } ?>
            </tbody>
          </table>
        <? } ?>
      </div>
    </div>

    <div id="SalesView" class="tabcontent">
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <input type="text" id="sales-order-search" onkeyup="filterSales()" placeholder="Buscar por Número de Pedido..." style="flex-grow: 1;">
        <input type="text" id="sales-product-search" onkeyup="filterSales()" placeholder="Buscar por Nombre de Producto..." style="flex-grow: 1;">
      </div>
      <div id="sales-accordion-container"></div>
    </div>

    <div id="footer-buttons">
      <button onclick="launchInventoryUpdate()">Actualizar Inventario</button>
    </div>

    <script>
      let salesData = null; // To store sales data once fetched

      function openView(evt, viewName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(viewName).style.display = "block";
        evt.currentTarget.className += " active";

        if (viewName === 'SalesView' && !salesData) {
          // Fetch data only if it hasn't been fetched yet
          document.getElementById('sales-accordion-container').innerHTML = '<p>Cargando datos de ventas...</p>';
          google.script.run
            .withSuccessHandler(renderSalesAccordion)
            .withFailureHandler(showError)
            .getSalesData();
        }
      }

      document.getElementById("defaultOpen").click();

      function filterTable() {
        const input = document.getElementById("search-input");
        const filter = input.value.toUpperCase();
        const table = document.getElementById("detailed-table");
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) { // Start from 1 to skip the header row
          const td = tr[i].getElementsByTagName("td")[0]; // Get the first cell (Producto Base)
          if (td) {
            const txtValue = td.textContent || td.innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
              tr[i].style.display = "";
            } else {
              tr[i].style.display = "none";
            }
          }
        }
      }

      function renderSalesAccordion(data) {
        if (data.error) {
          showError({message: data.error});
          return;
        }
        salesData = data;
        const container = document.getElementById('sales-accordion-container');
        container.innerHTML = '';

        if (Object.keys(salesData).length === 0) {
          container.innerHTML = '<p>No se encontraron datos de ventas.</p>';
          return;
        }

        for (const orderId in salesData) {
          const order = salesData[orderId];
          const accordionBtn = document.createElement('button');
          accordionBtn.className = 'accordion';
          accordionBtn.innerHTML = `Pedido: <strong>${orderId}</strong> - Teléfono: ${order.phone}`;
          
          const panel = document.createElement('div');
          panel.className = 'panel';
          
          let tableHTML = '<table><thead><tr><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
          order.products.forEach(product => {
            tableHTML += `<tr><td>${product.name}</td><td>${product.quantity}</td></tr>`;
          });
          tableHTML += '</tbody></table>';
          panel.innerHTML = tableHTML;

          accordionBtn.addEventListener('click', function() {
            this.classList.toggle('active');
            const panel = this.nextElementSibling;
            if (panel.style.maxHeight) {
              panel.style.maxHeight = null;
            } else {
              panel.style.maxHeight = panel.scrollHeight + "px";
            }
          });

          container.appendChild(accordionBtn);
          container.appendChild(panel);
        }
      }

      function filterSales() {
        const orderFilter = document.getElementById('sales-order-search').value.toLowerCase();
        const productFilter = document.getElementById('sales-product-search').value.toLowerCase();
        const accordions = document.getElementById('sales-accordion-container').getElementsByClassName('accordion');

        for (let i = 0; i < accordions.length; i++) {
          const btn = accordions[i];
          const orderId = btn.querySelector('strong').textContent.toLowerCase();
          const panel = btn.nextElementSibling;
          const productsText = panel.textContent.toLowerCase();

          const orderMatch = orderId.includes(orderFilter);
          const productMatch = productFilter === '' || productsText.includes(productFilter);

          if (orderMatch && productMatch) {
            btn.style.display = '';
            panel.style.display = '';
          } else {
            btn.style.display = 'none';
            panel.style.display = 'none';
          }
        }
      }

      function showError(err) {
        alert('Error: ' + err.message);
        const container = document.getElementById('sales-accordion-container');
        if(container) {
            container.innerHTML = `<p style="color: red;">Error al cargar los datos: ${err.message}</p>`;
        }
      }

      function launchInventoryUpdate() {
        google.script.run
          .withSuccessHandler(() => {
            google.script.host.close();
          })
          .launchInventoryCompletion();
      }
    </script>
  </body>
</html>
